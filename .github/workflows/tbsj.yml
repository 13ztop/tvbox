name: Sync from cluntop/tvbox

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点（北京时间8点）自动同步
  workflow_dispatch:      # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          repository: 13ztop/tvbox
          path: my-repo
          ref: main  # 如果您的仓库使用master分支，请改为master
          
      - name: Backup your files
        run: |
          mkdir -p /tmp/repo-backup
          cp my-repo/README.md /tmp/repo-backup/README.md 2>/dev/null || true
          cp my-repo/DISCLAIMER.md /tmp/repo-backup/DISCLAIMER.md 2>/dev/null || true
          echo "Backed up your README.md and DISCLAIMER.md"
          
      - name: Clone source repo
        run: |
          git clone https://github.com/cluntop/tvbox.git source-repo
          cd source-repo
          git checkout main  # 如果源仓库使用master分支，请改为master
          
      - name: Sync files
        run: |
          # 同步所有文件，但排除需要保留的文件
          rsync -av --delete \
            --exclude=README.md \
            --exclude=DISCLAIMER.md \
            --exclude=.git \
            source-repo/ my-repo/
            
      - name: Restore your files
        run: |
          cp /tmp/repo-backup/README.md my-repo/README.md 2>/dev/null || true
          cp /tmp/repo-backup/DISCLAIMER.md my-repo/DISCLAIMER.md 2>/dev/null || true
          echo "Restored your README.md and DISCLAIMER.md"
          
      - name: Commit and push changes
        id: commit_push
        run: |
          cd my-repo
          git config user.name "GitHub Actions Sync"
          git config user.email "actions@github.com"
          git add -A
          
          if git diff-index --quiet HEAD --; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            commit_msg="Auto-sync from cluntop/tvbox: $(date -u +'%Y-%m-%d %H:%M UTC')"
            git commit -m "$commit_msg"
            git push origin main  # 如果您的仓库使用master分支，请改为master
            echo "commit_msg=$commit_msg" >> $GITHUB_OUTPUT
            echo "Changes pushed successfully"
          fi
          
      - name: Cleanup
        run: |
          rm -rf source-repo
          rm -rf /tmp/repo-backup
          
      # ===== 新增 Telegram 通知部分 =====
      - name: Notify Telegram on Success
        if: success() && steps.commit_push.outputs.commit_msg
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            🔄 *仓库同步成功!*
            ━━━━━━━━━━━━━━━━
            • **源仓库**: [cluntop/tvbox](https://github.com/cluntop/tvbox)
            • **目标仓库**: [${{ github.repository }}](https://github.com/${{ github.repository }})
            • **提交信息**: ${{ steps.commit_push.outputs.commit_msg }}
            • **工作流**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ━━━━━━━━━━━━━━━━
            更改已成功推送!
          parse_mode: markdown
          
      - name: Notify Telegram on No Changes
        if: success() && steps.commit_push.outputs.no_changes
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ℹ️ *仓库同步完成 (无变更)*
            ━━━━━━━━━━━━━━━━
            • **源仓库**: [cluntop/tvbox](https://github.com/cluntop/tvbox)
            • **目标仓库**: [${{ github.repository }}](https://github.com/${{ github.repository }})
            • **工作流**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ━━━━━━━━━━━━━━━━
            源仓库与目标仓库内容一致，无需更新。
          parse_mode: markdown
          
      - name: Notify Telegram on Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‼️ *仓库同步失败!*
            ━━━━━━━━━━━━━━━━
            • **源仓库**: [cluntop/tvbox](https://github.com/cluntop/tvbox)
            • **目标仓库**: [${{ github.repository }}](https://github.com/${{ github.repository }})
            • **工作流**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ━━━━━━━━━━━━━━━━
            请立即检查错误日志!
            [查看日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown
      # ===== 新增部分结束 =====
