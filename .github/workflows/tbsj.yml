name: Sync from cluntop/tvbox

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          repository: 13ztop/tvbox
          path: my-repo
          ref: main  # å¦‚æœæ‚¨çš„ä»“åº“ä½¿ç”¨masteråˆ†æ”¯ï¼Œè¯·æ”¹ä¸ºmaster
          
      - name: Backup your files
        run: |
          mkdir -p /tmp/repo-backup
          cp my-repo/README.md /tmp/repo-backup/README.md 2>/dev/null || true
          cp my-repo/DISCLAIMER.md /tmp/repo-backup/DISCLAIMER.md 2>/dev/null || true
          echo "Backed up your README.md and DISCLAIMER.md"
          
      - name: Clone source repo
        run: |
          git clone https://github.com/cluntop/tvbox.git source-repo
          cd source-repo
          git checkout main  # å¦‚æœæºä»“åº“ä½¿ç”¨masteråˆ†æ”¯ï¼Œè¯·æ”¹ä¸ºmaster
          
      - name: Sync files
        run: |
          # åŒæ­¥æ‰€æœ‰æ–‡ä»¶ï¼Œä½†æ’é™¤éœ€è¦ä¿ç•™çš„æ–‡ä»¶
          rsync -av --delete \
            --exclude=README.md \
            --exclude=DISCLAIMER.md \
            --exclude=.git \
            source-repo/ my-repo/
            
      - name: Restore your files
        run: |
          cp /tmp/repo-backup/README.md my-repo/README.md 2>/dev/null || true
          cp /tmp/repo-backup/DISCLAIMER.md my-repo/DISCLAIMER.md 2>/dev/null || true
          echo "Restored your README.md and DISCLAIMER.md"
          
      - name: Commit and push changes
        id: commit_push
        run: |
          cd my-repo
          git config user.name "GitHub Actions Sync"
          git config user.email "actions@github.com"
          git add -A
          
          if git diff-index --quiet HEAD --; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            commit_msg="Auto-sync from cluntop/tvbox: $(date -u +'%Y-%m-%d %H:%M UTC')"
            git commit -m "$commit_msg"
            git push origin main  # å¦‚æœæ‚¨çš„ä»“åº“ä½¿ç”¨masteråˆ†æ”¯ï¼Œè¯·æ”¹ä¸ºmaster
            echo "commit_msg=$commit_msg" >> $GITHUB_OUTPUT
            echo "Changes pushed successfully"
          fi
          
      - name: Cleanup
        run: |
          rm -rf source-repo
          rm -rf /tmp/repo-backup
          
      # ===== æ–°å¢ Telegram é€šçŸ¥éƒ¨åˆ† =====
      - name: Notify Telegram on Success
        if: success() && steps.commit_push.outputs.commit_msg
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ”„ *ä»“åº“åŒæ­¥æˆåŠŸ!*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **æºä»“åº“**: [cluntop/tvbox](https://github.com/cluntop/tvbox)
            â€¢ **ç›®æ ‡ä»“åº“**: [${{ github.repository }}](https://github.com/${{ github.repository }})
            â€¢ **æäº¤ä¿¡æ¯**: ${{ steps.commit_push.outputs.commit_msg }}
            â€¢ **å·¥ä½œæµ**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            æ›´æ”¹å·²æˆåŠŸæ¨é€!
          parse_mode: markdown
          
      - name: Notify Telegram on No Changes
        if: success() && steps.commit_push.outputs.no_changes
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            â„¹ï¸ *ä»“åº“åŒæ­¥å®Œæˆ (æ— å˜æ›´)*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **æºä»“åº“**: [cluntop/tvbox](https://github.com/cluntop/tvbox)
            â€¢ **ç›®æ ‡ä»“åº“**: [${{ github.repository }}](https://github.com/${{ github.repository }})
            â€¢ **å·¥ä½œæµ**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            æºä»“åº“ä¸ç›®æ ‡ä»“åº“å†…å®¹ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°ã€‚
          parse_mode: markdown
          
      - name: Notify Telegram on Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            â€¼ï¸ *ä»“åº“åŒæ­¥å¤±è´¥!*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **æºä»“åº“**: [cluntop/tvbox](https://github.com/cluntop/tvbox)
            â€¢ **ç›®æ ‡ä»“åº“**: [${{ github.repository }}](https://github.com/${{ github.repository }})
            â€¢ **å·¥ä½œæµ**: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            è¯·ç«‹å³æ£€æŸ¥é”™è¯¯æ—¥å¿—!
            [æŸ¥çœ‹æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown
      # ===== æ–°å¢éƒ¨åˆ†ç»“æŸ =====
