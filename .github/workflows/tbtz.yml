name: Smart Sync from cluntop/tvbox

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          repository: 13ztop/tvbox
          path: my-repo
          ref: main
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
          
      - name: Create backup directory
        run: mkdir -p /tmp/repo-backup
          
      - name: Identify custom files
        id: find_custom
        run: |
          # å…‹éš†æºä»“åº“ç”¨äºæ¯”è¾ƒ
          git clone --depth 1 https://github.com/cluntop/tvbox.git source-repo
          
          # æŸ¥æ‰¾ç›®æ ‡ä»“åº“ç‹¬æœ‰çš„æ–‡ä»¶ï¼ˆæ’é™¤.gitç›®å½•ï¼‰
          cd my-repo
          find . -type f -not -path './.git/*' | while read file; do
            if [ ! -f "../source-repo/$file" ]; then
              # æ’é™¤Gitå†…éƒ¨æ–‡ä»¶å’Œå·¥ä½œæµç›®å½•
              if [[ "$file" != *".github/workflows/"* ]]; then
                echo "Custom file detected: $file"
                echo "$file" >> /tmp/repo-backup/custom-files.txt
              fi
            fi
          done
          
          # ä¿å­˜è‡ªå®šä¹‰æ–‡ä»¶æ•°é‡
          if [ -f /tmp/repo-backup/custom-files.txt ]; then
            custom_count=$(wc -l < /tmp/repo-backup/custom-files.txt)
            echo "custom_files_count=$custom_count" >> $GITHUB_OUTPUT
          else
            echo "custom_files_count=0" >> $GITHUB_OUTPUT
          fi
          
          echo "Custom files identification complete"
          
      - name: Get source repository version
        id: source_version
        run: |
          cd source-repo
          echo "commit_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "full_hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "commit_date=$(git log -1 --format=%cd --date=format:'%Y-%m-%d')" >> $GITHUB_OUTPUT
          
      - name: Get target repository commit
        id: target_version
        run: |
          cd my-repo
          echo "TARGET_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          
      - name: Backup protected content
        run: |
          # å¤‡ä»½éœ€è¦ä¿æŠ¤çš„æ ¸å¿ƒæ–‡ä»¶
          cp my-repo/README.md /tmp/repo-backup/ 2>/dev/null || true
          cp my-repo/DISCLAIMER.md /tmp/repo-backup/ 2>/dev/null || true
          
          # å¤‡ä»½æ•´ä¸ªé…ç½®å’Œå·¥ä½œæµç›®å½•
          mkdir -p /tmp/repo-backup/.github
          cp -R my-repo/.github/* /tmp/repo-backup/.github/ 2>/dev/null || true
          
          # å¤‡ä»½è‡ªå®šä¹‰æ–‡ä»¶ï¼ˆåŸºäºä¸Šä¸€æ­¥çš„æ£€æµ‹ï¼‰
          if [ -f /tmp/repo-backup/custom-files.txt ]; then
            mkdir -p /tmp/repo-backup/custom-files
            while read file; do
              mkdir -p "/tmp/repo-backup/custom-files/$(dirname "$file")"
              cp "my-repo/$file" "/tmp/repo-backup/custom-files/$file"
            done < /tmp/repo-backup/custom-files.txt
          fi
          
          echo "Protected content backed up"
          
      - name: Full sync from source
        run: |
          # ä½¿ç”¨rsyncè¦†ç›–æ‰€æœ‰æºä»“åº“å­˜åœ¨çš„æ–‡ä»¶
          rsync -av --delete \
            --exclude=.git \
            --exclude=README.md \
            --exclude=DISCLAIMER.md \
            --exclude=.github \
            source-repo/ my-repo/
          
          echo "Source files synced, protected files excluded"
            
      - name: Restore protected content
        run: |
          # æ¢å¤æ ¸å¿ƒæ–‡ä»¶
          cp /tmp/repo-backup/README.md my-repo/ 2>/dev/null || true
          cp /tmp/repo-backup/DISCLAIMER.md my-repo/ 2>/dev/null || true
          
          # æ¢å¤å·¥ä½œæµé…ç½®
          mkdir -p my-repo/.github
          cp -R /tmp/repo-backup/.github/* my-repo/.github/ 2>/dev/null || true
          
          # æ¢å¤è‡ªå®šä¹‰æ–‡ä»¶
          if [ -d /tmp/repo-backup/custom-files ]; then
            cd /tmp/repo-backup/custom-files
            find . -type f | while read file; do
              mkdir -p "$GITHUB_WORKSPACE/my-repo/$(dirname "$file")"
              cp "$file" "$GITHUB_WORKSPACE/my-repo/$file"
            done
          fi
          
          echo "Protected content restored"
          
      - name: Commit and push changes
        id: commit_push
        run: |
          cd my-repo
          git config user.name "GitHub Actions Sync"
          git config user.email "actions@github.com"
          git add -A
          
          # æ£€æŸ¥å˜æ›´
          if git diff-index --quiet HEAD --; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "no_changes_detected=true" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„å˜æ›´"
          else
            # è®¡ç®—å˜æ›´æ–‡ä»¶æ•°é‡
            changes_count=$(git diff --name-only HEAD | wc -l)
            echo "changes_count=$changes_count" >> $GITHUB_OUTPUT
            
            # ç”Ÿæˆæäº¤ä¿¡æ¯
            commit_msg="æ™ºèƒ½åŒæ­¥: æ›´æ–° $changes_count ä¸ªæ–‡ä»¶"
            if [ -f /tmp/repo-backup/custom-files.txt ]; then
              custom_count=$(wc -l < /tmp/repo-backup/custom-files.txt)
              commit_msg+=", ä¿ç•™ $custom_count ä¸ªè‡ªå®šä¹‰æ–‡ä»¶"
            fi
            
            git commit -m "$commit_msg"
            git push origin main
            echo "commit_msg=$commit_msg" >> $GITHUB_OUTPUT
            echo "å˜æ›´å·²æˆåŠŸæ¨é€"
          fi
          
      - name: Cleanup
        run: |
          rm -rf source-repo
          rm -rf /tmp/repo-backup
          
      # ======================
      # æ•´åˆé€šçŸ¥ç³»ç»Ÿ
      # ======================
      # è®¾ç½®å½“å‰æ—¶é—´ï¼ˆç”¨äºæ‰€æœ‰é€šçŸ¥ï¼‰
      - name: Set current time
        id: set_time
        run: |
          echo "CURRENT_TIME=$(date -u +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV
          echo "CURRENT_TIME_SHORT=$(date -u +'%H:%M UTC')" >> $GITHUB_ENV
          
      - name: Notify Telegram on Sync Success
        if: success() && steps.commit_push.outputs.commit_msg
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸ”„ *æ™ºèƒ½åŒæ­¥æŠ¥å‘Š | ${{ steps.source_version.outputs.commit_date }} (${{ env.CURRENT_TIME_SHORT }})*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“¦ **æºä»“åº“**: [cluntop/tvbox@${{ steps.source_version.outputs.commit_hash }}](https://github.com/cluntop/tvbox/commit/${{ steps.source_version.outputs.full_hash }})
            ğŸ  **ç›®æ ‡ä»“åº“**: [${{ github.repository }}@${{ env.TARGET_COMMIT }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **å˜æ›´**: ${{ steps.commit_push.outputs.changes_count }} ä¸ªæ–‡ä»¶æ›´æ–°
            â€¢ **ä¿ç•™**: ${{ steps.find_custom.outputs.custom_files_count }} ä¸ªè‡ªå®šä¹‰æ–‡ä»¶
            â€¢ **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âœ… åŒæ­¥æˆåŠŸ! æ‰€æœ‰æ›´æ–°å·²åº”ç”¨
            [æŸ¥çœ‹å·¥ä½œæµè¿è¡Œ](#${{ github.run_number }})
          parse_mode: markdown
          
      - name: Notify Telegram on No Changes
        if: success() && steps.commit_push.outputs.no_changes_detected
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            â„¹ï¸ *æ™ºèƒ½åŒæ­¥æŠ¥å‘Š | ${{ steps.source_version.outputs.commit_date }} (${{ env.CURRENT_TIME_SHORT }})*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“¦ **æºä»“åº“**: [cluntop/tvbox@${{ steps.source_version.outputs.commit_hash }}](https://github.com/cluntop/tvbox/commit/${{ steps.source_version.outputs.full_hash }})
            ğŸ  **ç›®æ ‡ä»“åº“**: [${{ github.repository }}@${{ env.TARGET_COMMIT }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **ä¿ç•™æ–‡ä»¶**: ${{ steps.find_custom.outputs.custom_files_count }} ä¸ª
            â€¢ **åŒæ­¥çŠ¶æ€**: å†…å®¹ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°
            â€¢ **æ£€æµ‹æ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            âœ… ä»“åº“å·²æ˜¯æœ€æ–°çŠ¶æ€
            [æŸ¥çœ‹æˆ‘çš„ä»“åº“æ›´æ”¹è®°å½•](https://github.com/${{ github.repository }}/commits/main)
          parse_mode: markdown
          
      - name: Notify Telegram on Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            â€¼ï¸ *æ™ºèƒ½åŒæ­¥æŠ¥å‘Š | åŒæ­¥å¤±è´¥ (${{ env.CURRENT_TIME_SHORT }})*
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“¦ **æºä»“åº“**: [cluntop/tvbox](https://github.com/cluntop/tvbox)
            ğŸ  **ç›®æ ‡ä»“åº“**: [${{ github.repository }}](https://github.com/${{ github.repository }})
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            â€¢ **å¤±è´¥é˜¶æ®µ**: ${{ job.status }}
            â€¢ **å·¥ä½œæµ**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            â€¢ **å‘ç”Ÿæ—¶é—´**: ${{ env.CURRENT_TIME }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸš¨ éœ€è¦ç«‹å³å¤„ç†!
            [æŸ¥çœ‹é”™è¯¯æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown
