name: Smart Sync from cluntop/tvbox

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点（北京时间8点）自动同步
  workflow_dispatch:      # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.SYNC_TOKEN }}
          repository: 13ztop/tvbox
          path: my-repo
          ref: main
          fetch-depth: 0  # 获取完整历史记录
          
      - name: Create backup directory
        run: mkdir -p /tmp/repo-backup
          
      - name: Identify custom files
        id: find_custom
        run: |
          # 克隆源仓库用于比较
          git clone --depth 1 https://github.com/cluntop/tvbox.git source-repo
          
          # 查找目标仓库独有的文件（排除.git目录）
          cd my-repo
          find . -type f -not -path './.git/*' | while read file; do
            if [ ! -f "../source-repo/$file" ]; then
              # 排除Git内部文件和工作流目录
              if [[ "$file" != *".github/workflows/"* ]]; then
                echo "Custom file detected: $file"
                echo "$file" >> /tmp/repo-backup/custom-files.txt
              fi
            fi
          done
          
          # 保存自定义文件数量
          if [ -f /tmp/repo-backup/custom-files.txt ]; then
            custom_count=$(wc -l < /tmp/repo-backup/custom-files.txt)
            echo "custom_files_count=$custom_count" >> $GITHUB_OUTPUT
          else
            echo "custom_files_count=0" >> $GITHUB_OUTPUT
          fi
          
          echo "Custom files identification complete"
          
      - name: Backup protected content
        run: |
          # 备份需要保护的核心文件
          cp my-repo/README.md /tmp/repo-backup/ 2>/dev/null || true
          cp my-repo/DISCLAIMER.md /tmp/repo-backup/ 2>/dev/null || true
          
          # 备份整个配置和工作流目录
          mkdir -p /tmp/repo-backup/.github
          cp -R my-repo/.github/* /tmp/repo-backup/.github/ 2>/dev/null || true
          
          # 备份自定义文件（基于上一步的检测）
          if [ -f /tmp/repo-backup/custom-files.txt ]; then
            mkdir -p /tmp/repo-backup/custom-files
            while read file; do
              mkdir -p "/tmp/repo-backup/custom-files/$(dirname "$file")"
              cp "my-repo/$file" "/tmp/repo-backup/custom-files/$file"
            done < /tmp/repo-backup/custom-files.txt
          fi
          
          echo "Protected content backed up"
          
      - name: Full sync from source
        run: |
          # 使用rsync覆盖所有源仓库存在的文件
          rsync -av --delete \
            --exclude=.git \
            --exclude=README.md \
            --exclude=DISCLAIMER.md \
            --exclude=.github \
            source-repo/ my-repo/
          
          echo "Source files synced, protected files excluded"
            
      - name: Restore protected content
        run: |
          # 恢复核心文件
          cp /tmp/repo-backup/README.md my-repo/ 2>/dev/null || true
          cp /tmp/repo-backup/DISCLAIMER.md my-repo/ 2>/dev/null || true
          
          # 恢复工作流配置
          mkdir -p my-repo/.github
          cp -R /tmp/repo-backup/.github/* my-repo/.github/ 2>/dev/null || true
          
          # 恢复自定义文件
          if [ -d /tmp/repo-backup/custom-files ]; then
            cd /tmp/repo-backup/custom-files
            find . -type f | while read file; do
              mkdir -p "$GITHUB_WORKSPACE/my-repo/$(dirname "$file")"
              cp "$file" "$GITHUB_WORKSPACE/my-repo/$file"
            done
          fi
          
          echo "Protected content restored"
          
      - name: Commit and push changes
        id: commit_push
        run: |
          cd my-repo
          git config user.name "GitHub Actions Sync"
          git config user.email "actions@github.com"
          git add -A
          
          # 检查变更
          if git diff-index --quiet HEAD --; then
            echo "no_changes=true" >> $GITHUB_OUTPUT
            echo "no_changes_detected=true" >> $GITHUB_OUTPUT
            echo "没有需要提交的变更"
          else
            # 生成提交信息
            commit_msg="智能同步: 更新源文件"
            if [ -f /tmp/repo-backup/custom-files.txt ]; then
              custom_count=$(wc -l < /tmp/repo-backup/custom-files.txt)
              commit_msg+=", 保留 $custom_count 个自定义文件"
            fi
            
            git commit -m "$commit_msg"
            git push origin main
            echo "commit_msg=$commit_msg" >> $GITHUB_OUTPUT
            echo "变更已成功推送"
          fi
          
      - name: Cleanup
        run: |
          rm -rf source-repo
          rm -rf /tmp/repo-backup
          
      # Telegram 通知
      - name: Notify Telegram on Sync Success
        if: success() && steps.commit_push.outputs.commit_msg
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            🔄 *智能同步完成!*
            ━━━━━━━━━━━━━━━━━━━━
            • **提交信息**: ${{ steps.commit_push.outputs.commit_msg }}
            • **保留文件**: ${{ steps.find_custom.outputs.custom_files_count }} 个
            ━━━━━━━━━━━━━━━━━━━━
            ✅ 源文件已更新
            ✅ 自定义文件已保留
            ✅ 工作流配置未更改
            [查看提交](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          parse_mode: markdown
          
      - name: Notify Telegram on No Changes
        if: success() && steps.commit_push.outputs.no_changes_detected
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ℹ️ *智能同步完成 (无变更)*
            ━━━━━━━━━━━━━━━━━━━━
            • **保留文件**: ${{ steps.find_custom.outputs.custom_files_count }} 个
            ━━━━━━━━━━━━━━━━━━━━
            源仓库与目标仓库内容一致，无需更新。
            所有自定义文件保持原样。
          parse_mode: markdown
          
      - name: Notify Telegram on Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ‼️ *智能同步失败!*
            ━━━━━━━━━━━━━━━━━━━━
            • **工作流**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            ━━━━━━━━━━━━━━━━━━━━
            错误发生在 ${{ job.status }} 阶段
            请立即检查日志!
            [查看日志](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          parse_mode: markdown
